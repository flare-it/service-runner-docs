
<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>Augi Service Reference</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight .gh {
  color: #999999;
}
.highlight .sr {
  color: #f6aa11;
}
.highlight .go {
  color: #888888;
}
.highlight .gp {
  color: #555555;
}
.highlight .gs {
}
.highlight .gu {
  color: #aaaaaa;
}
.highlight .nb {
  color: #f6aa11;
}
.highlight .cm {
  color: #75715e;
}
.highlight .cp {
  color: #75715e;
}
.highlight .c1 {
  color: #75715e;
}
.highlight .cs {
  color: #75715e;
}
.highlight .c, .highlight .cd {
  color: #75715e;
}
.highlight .err {
  color: #960050;
}
.highlight .gr {
  color: #960050;
}
.highlight .gt {
  color: #960050;
}
.highlight .gd {
  color: #49483e;
}
.highlight .gi {
  color: #49483e;
}
.highlight .ge {
  color: #49483e;
}
.highlight .kc {
  color: #66d9ef;
}
.highlight .kd {
  color: #66d9ef;
}
.highlight .kr {
  color: #66d9ef;
}
.highlight .no {
  color: #66d9ef;
}
.highlight .kt {
  color: #66d9ef;
}
.highlight .mf {
  color: #ae81ff;
}
.highlight .mh {
  color: #ae81ff;
}
.highlight .il {
  color: #ae81ff;
}
.highlight .mi {
  color: #ae81ff;
}
.highlight .mo {
  color: #ae81ff;
}
.highlight .m, .highlight .mb, .highlight .mx {
  color: #ae81ff;
}
.highlight .sc {
  color: #ae81ff;
}
.highlight .se {
  color: #ae81ff;
}
.highlight .ss {
  color: #ae81ff;
}
.highlight .sd {
  color: #e6db74;
}
.highlight .s2 {
  color: #e6db74;
}
.highlight .sb {
  color: #e6db74;
}
.highlight .sh {
  color: #e6db74;
}
.highlight .si {
  color: #e6db74;
}
.highlight .sx {
  color: #e6db74;
}
.highlight .s1 {
  color: #e6db74;
}
.highlight .s {
  color: #e6db74;
}
.highlight .na {
  color: #a6e22e;
}
.highlight .nc {
  color: #a6e22e;
}
.highlight .nd {
  color: #a6e22e;
}
.highlight .ne {
  color: #a6e22e;
}
.highlight .nf {
  color: #a6e22e;
}
.highlight .vc {
  color: #ffffff;
}
.highlight .nn {
  color: #ffffff;
}
.highlight .nl {
  color: #ffffff;
}
.highlight .ni {
  color: #ffffff;
}
.highlight .bp {
  color: #ffffff;
}
.highlight .vg {
  color: #ffffff;
}
.highlight .vi {
  color: #ffffff;
}
.highlight .nv {
  color: #ffffff;
}
.highlight .w {
  color: #ffffff;
}
.highlight {
  color: #ffffff;
}
.highlight .n, .highlight .py, .highlight .nx {
  color: #ffffff;
}
.highlight .ow {
  color: #f92672;
}
.highlight .nt {
  color: #f92672;
}
.highlight .k, .highlight .kv {
  color: #f92672;
}
.highlight .kn {
  color: #f92672;
}
.highlight .kp {
  color: #f92672;
}
.highlight .o {
  color: #f92672;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="index" data-languages="[&quot;javascript&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="toc-wrapper">
      <img src="images/logo.png" class="logo" alt="Logo" />
        <div class="lang-selector">
              <a href="#" data-language-name="javascript">javascript</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <ul id="toc" class="toc-list-h1">
          <li>
            <a href="#introduction" class="toc-h1 toc-link" data-title="Introduction">Introduction</a>
          </li>
          <li>
            <a href="#folder-structure" class="toc-h1 toc-link" data-title="Folder structure">Folder structure</a>
          </li>
          <li>
            <a href="#service-components" class="toc-h1 toc-link" data-title="Service components">Service components</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#the-configuration-file" class="toc-h2 toc-link" data-title="The configuration file">The configuration file</a>
                  </li>
                  <li>
                    <a href="#context-enhancers" class="toc-h2 toc-link" data-title="Context enhancers">Context enhancers</a>
                  </li>
                  <li>
                    <a href="#helper-functions" class="toc-h2 toc-link" data-title="Helper functions">Helper functions</a>
                  </li>
                  <li>
                    <a href="#event-handlers" class="toc-h2 toc-link" data-title="Event handlers">Event handlers</a>
                  </li>
                  <li>
                    <a href="#invocation-handlers" class="toc-h2 toc-link" data-title="Invocation handlers">Invocation handlers</a>
                  </li>
                  <li>
                    <a href="#task-handlers" class="toc-h2 toc-link" data-title="Task handlers">Task handlers</a>
                  </li>
                  <li>
                    <a href="#models" class="toc-h2 toc-link" data-title="Models">Models</a>
                  </li>
              </ul>
          </li>
          <li>
            <a href="#testing" class="toc-h1 toc-link" data-title="Testing">Testing</a>
          </li>
          <li>
            <a href="#restrictions" class="toc-h1 toc-link" data-title="Restrictions">Restrictions</a>
              <ul class="toc-list-h2">
                  <li>
                    <a href="#the-service-name" class="toc-h2 toc-link" data-title="The service name">The service name</a>
                  </li>
                  <li>
                    <a href="#context-enhancers-2" class="toc-h2 toc-link" data-title="Context enhancers">Context enhancers</a>
                  </li>
              </ul>
          </li>
      </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        <h1 id='introduction'>Introduction</h1>
<p>Nuff said!</p>
<h1 id='folder-structure'>Folder structure</h1>
<blockquote>
<p>The following shows a possible folder structure</p>
</blockquote>
<pre class="highlight shell tab-shell"><code>
<span class="c"># /some-service</span>
<span class="c">#   /index.js</span>
<span class="c">#   /context</span>
<span class="c">#     /some-context-enhancer.js</span>
<span class="c">#   /helpers</span>
<span class="c">#     some-helper.js</span>
<span class="c">#   /handlers</span>
<span class="c">#     /events</span>
<span class="c">#       /some-event.js</span>
<span class="c">#       /another-event.js</span>
<span class="c">#     /invocations</span>
<span class="c">#       /some-invocation.js</span>
<span class="c">#       /another-invocation.js</span>
<span class="c">#     /tasks</span>
<span class="c">#       /some-task.js</span>
<span class="c">#       /another-task.js</span>
<span class="c">#   /models</span>
<span class="c">#     /some-model.js</span>

</code></pre>
<p>The service shown is called <code>some-service</code>. It contains the optional configuration file <code>index.js</code>. The handlers folder are the various implemented handlers. They will be explained further down. The folder <code>context</code> contains so called context enhancers. Files inside will be able to add parameters to the context object. This is useful if you need to create a client for another service like elasticsearch etc. The <code>models</code> folder contains model definitions that will be loaded on service start.</p>
<h1 id='service-components'>Service components</h1>
<p>The following section will go into detail on the previously described components.</p>
<h2 id='the-configuration-file'>The configuration file</h2>
<blockquote>
<p>Below is an example definition of an index.js file</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">name</span><span class="p">:</span> <span class="s1">'some-cool-service'</span><span class="p">,</span>  <span class="c1">// This setting can override the actual service name</span>
  <span class="na">context</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// Custom context enhancers can be given configuration parameters which they will receive via their execution context</span>
    <span class="na">foo</span><span class="p">:</span> <span class="p">{</span>    <span class="c1">// the foo enhancer will be able to access foo under `context.config.foo`</span>
      <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">config</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// config which is available to all handler (invocations, tasks and events)</span>
    <span class="na">threshold</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="na">maxSessions</span><span class="p">:</span> <span class="mi">5</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre>
<p>The configuration file is optional. It can define specific parameters.</p>
<h2 id='context-enhancers'>Context enhancers</h2>
<blockquote>
<p>A sample context enhancer</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="cm">/**
 * A sample context enhancer
 *
 * @param context - The context of the handler
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// do some startup stuff</span>
<span class="p">};</span>

</code></pre>
<blockquote>
<p>The context contains the following parameters:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">env</span><span class="p">:</span> <span class="s2">"production"</span> <span class="c1">// the current environment we are running in</span>
  <span class="na">shortEnv</span><span class="p">:</span> <span class="s2">"prod"</span><span class="p">,</span> <span class="c1">// the short form of the current environment</span>
  <span class="na">service</span><span class="p">:</span> <span class="s2">"some-cool-service"</span><span class="p">,</span> <span class="c1">// the name of the current service</span>
  <span class="na">config</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// optional config parameters which are provided automatically through the config file</span>
    <span class="na">bar</span><span class="p">:</span> <span class="mi">123</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>A context enhancer can enhance the handlers context object. Each context enhancer gets loaded once on service startup.</p>

<p>If an enhancer throws an error when run the service will abort startup.</p>
<h2 id='helper-functions'>Helper functions</h2>
<blockquote>
<p>A sample helper function (this can be anything)</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// add-values.js - will be available as "context.helpers.addValues(a, b)"</span>

<span class="kr">const</span> <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">add</span><span class="p">;</span>

</code></pre>
<p>A helper function can have any form you would like. File names will be camel cased. This means that the file name <code>foo-bar.js</code> will result in the key <code>fooBar</code>.</p>
<h2 id='event-handlers'>Event handlers</h2>
<blockquote>
<p>An event handler has the following signature:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="cm">/**
 * The event handler
 *
 * @param context - The current context of the handler
 * @param payload - The payload of the event to handle
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// handle event</span>
  <span class="c1">// If error is thrown then event will be re-handled</span>
<span class="p">};</span>

</code></pre>
<blockquote>
<p>The context contains the following parameters:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">cid</span><span class="p">:</span> <span class="s1">'f8682372-b20d-4c46-ab6b-d25656bf9a48'</span><span class="p">,</span> <span class="c1">// the correlation id of the initial request to track related logs</span>
  <span class="na">self</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'some-service'</span><span class="p">,</span> <span class="c1">// The name of the service that handles the event</span>
    <span class="na">handler</span><span class="p">:</span> <span class="s1">'some-handler'</span><span class="p">,</span>  <span class="c1">// The name of the event</span>
  <span class="p">},</span>
  <span class="na">event</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s1">'4943ace3-9864-44ac-a74b-4c1fee0feac1'</span><span class="p">,</span>
    <span class="na">from</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'another-service'</span><span class="p">,</span>  <span class="c1">// the name of the calling service</span>
      <span class="na">handler</span><span class="p">:</span> <span class="s1">'another-handler'</span>  <span class="c1">// The name of the handler from the calling service</span>
    <span class="p">},</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="s1">'2018-08-10T19:15:00+02:00'</span> <span class="c1">// An ISO8601 Timestamp string at the time of the event emission</span>
  <span class="p">},</span>
  <span class="na">emit</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span> <span class="c1">// Emit an event with a payload,</span>
  <span class="na">invoke</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">handlerName</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span> <span class="c1">// Invoke a handler of this or another service,</span>
  <span class="na">task</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">create</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">taskName</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">,</span>
    <span class="na">status</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">taskId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// Get the status of a task id (only if the task originated from this service)</span>
      <span class="na">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// The id of the task</span>
      <span class="na">progress</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="c1">// The current task progress</span>
      <span class="na">completed</span><span class="p">:</span> <span class="nb">Boolean</span>  <span class="c1">// true if the task was completed</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">cache</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache getters and setters</span>
    <span class="na">global</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// Cache values are available for all other services</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">},</span>
    <span class="na">service</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache values are only available for this service</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">log</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">info</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// an info message log</span>
    <span class="na">warn</span><span class="p">:</span>  <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// a warning message log</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span> <span class="c1">// an error message log</span>
  <span class="p">},</span>
  <span class="p">...</span> <span class="nx">models</span><span class="p">,</span> <span class="c1">// the models available to the service</span>
  <span class="p">...</span> <span class="nx">contextEnhancers</span><span class="p">,</span> <span class="c1">// the objects defined via context enhancers</span>
  <span class="na">config</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all available config constants from the service configuration</span>
  <span class="p">},</span>
  <span class="na">helpers</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all helper functions loaded from the helpers folder</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>An event handler gets called when a service emits an event. Events are when something happened in the emitting service, that other services might find useful. Event names are always in the past (eg. <code>something-happened</code>, <code>account-created</code> or <code>team-joined</code>).</p>
<h2 id='invocation-handlers'>Invocation handlers</h2>
<blockquote>
<p>An invocation handler has the following signature:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="cm">/**
 * The invocation handler
 *
 * @param context - The current context of the handler
 * @param paramOne - The first parameter of the invocation
 * @param paramTwo - The second parameter of the invocation
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">paramOne</span><span class="p">,</span> <span class="nx">paramTwo</span><span class="p">,</span> <span class="p">...)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// handle invocation</span>
  <span class="c1">// If error is thrown then invocation will throw on the calling side</span>
<span class="p">};</span>

</code></pre>
<blockquote>
<p>The context contains the following parameters:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">cid</span><span class="p">:</span> <span class="s1">'f8682372-b20d-4c46-ab6b-d25656bf9a48'</span><span class="p">,</span> <span class="c1">// the correlation id of the initial request to track related logs</span>
  <span class="na">self</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'some-service'</span><span class="p">,</span> <span class="c1">// The name of the service that handles the event</span>
    <span class="na">handler</span><span class="p">:</span> <span class="s1">'some-handler'</span><span class="p">,</span>  <span class="c1">// The name of the event</span>
  <span class="p">},</span>
  <span class="na">invocation</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s1">'19df39df-99ad-44ac-dc1a-4c1fee0feac1'</span><span class="p">,</span>
    <span class="na">from</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'another-service'</span><span class="p">,</span>  <span class="c1">// the name of the calling service</span>
      <span class="na">handler</span><span class="p">:</span> <span class="s1">'another-handler'</span>  <span class="c1">// The name of the handler from the calling service</span>
    <span class="p">},</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="s1">'2018-08-10T19:15:00+02:00'</span> <span class="c1">// An ISO8601 Timestamp string at the time of the event emission</span>
  <span class="p">},</span>
  <span class="na">emit</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">eventType</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span> <span class="c1">// Emit an event with a payload,</span>
  <span class="na">invoke</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">handlerName</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span> <span class="c1">// Invoke a handler of this or another service,</span>
  <span class="na">task</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">create</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">taskName</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">,</span>
    <span class="na">status</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">taskId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// Get the status of a task id (only if the task originated from this service)</span>
      <span class="na">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// The id of the task</span>
      <span class="na">progress</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="c1">// The current task progress</span>
      <span class="na">completed</span><span class="p">:</span> <span class="nb">Boolean</span>  <span class="c1">// true if the task was completed</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">cache</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache getters and setters</span>
    <span class="na">global</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// Cache values are available for all other services</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">},</span>
    <span class="na">service</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache values are only available for this service</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">log</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">info</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// an info message log</span>
    <span class="na">warn</span><span class="p">:</span>  <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// a warning message log</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span> <span class="c1">// an error message log</span>
  <span class="p">},</span>
  <span class="p">...</span> <span class="nx">models</span><span class="p">,</span> <span class="c1">// the models available to the service</span>
  <span class="p">...</span> <span class="nx">contextEnhancers</span><span class="p">,</span> <span class="c1">// the objects defined via context enhancers</span>
  <span class="na">config</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all available config constants from the service configuration</span>
  <span class="p">},</span>
  <span class="na">helpers</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all helper functions loaded from the helpers folder</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>An invocation handler is the most common handler type. It should be used for direct contact with another service.</p>
<h2 id='task-handlers'>Task handlers</h2>
<blockquote>
<p>A task handler has the following signature:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="cm">/**
 * The invocation handler
 *
 * @param context - The current context of the handler
 * @param payload - The payload of the task
 */</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">payload</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// handle task</span>
  <span class="c1">// If error is thrown then the task will be marked as failed</span>
<span class="p">};</span>
</code></pre>
<blockquote>
<p>The task context contains the following parameters:</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">cid</span><span class="p">:</span> <span class="s1">'f8682372-b20d-4c46-ab6b-d25656bf9a48'</span><span class="p">,</span> <span class="c1">// the correlation id of the initial request to track related logs</span>
  <span class="na">self</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">name</span><span class="p">:</span> <span class="s1">'some-service'</span><span class="p">,</span> <span class="c1">// The name of the service that handles the event</span>
    <span class="na">handler</span><span class="p">:</span> <span class="s1">'some-handler'</span><span class="p">,</span>  <span class="c1">// The name of the event</span>
  <span class="p">},</span>
  <span class="na">task</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s1">'19df39df-99ad-44ac-dc1a-4c1fee0feac1'</span><span class="p">,</span>
    <span class="na">from</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">name</span><span class="p">:</span> <span class="s1">'another-service'</span><span class="p">,</span>  <span class="c1">// the name of the calling service</span>
      <span class="na">handler</span><span class="p">:</span> <span class="s1">'another-handler'</span>  <span class="c1">// The name of the handler from the calling service</span>
    <span class="p">},</span>
    <span class="na">timestamp</span><span class="p">:</span> <span class="s1">'2018-08-10T19:15:00+02:00'</span><span class="p">,</span> <span class="c1">// An ISO8601 Timestamp string at the time of the event emission</span>
    <span class="na">create</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="na">serviceName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">taskName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">string</span><span class="p">,</span>
    <span class="na">status</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">taskId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// Get the status of a task id (only if the task originated from this service)</span>
      <span class="na">id</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="c1">// The id of the task</span>
      <span class="na">progress</span><span class="p">:</span> <span class="nb">Number</span><span class="p">,</span> <span class="c1">// The current task progress</span>
      <span class="na">completed</span><span class="p">:</span> <span class="nb">Boolean</span>  <span class="c1">// true if the task was completed</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">emit</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="na">eventType</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">any</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span> <span class="c1">// Emit an event with a payload</span>
  <span class="na">invoke</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="na">serviceName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="na">handlerName</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span> <span class="p">...</span><span class="na">params</span><span class="p">:</span> <span class="nx">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span> <span class="c1">// Invoke a handler of this or another service</span>
  <span class="na">cache</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache getters and setters</span>
    <span class="na">global</span><span class="p">:</span> <span class="p">{</span> <span class="c1">// Cache values are available for all other services</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">},</span>
    <span class="na">service</span><span class="p">:</span> <span class="p">{</span>  <span class="c1">// cache values are only available for this service</span>
      <span class="na">get</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">any</span><span class="p">,</span>  <span class="c1">// get a cached value or null</span>
      <span class="na">set</span><span class="p">:</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">cacheKey</span><span class="p">,</span> <span class="nx">cacheValue</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span>  <span class="c1">// set a cache value for a specific key</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="na">log</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">info</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// an info message log</span>
    <span class="na">warn</span><span class="p">:</span>  <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">,</span>  <span class="c1">// a warning message log</span>
    <span class="na">error</span><span class="p">:</span> <span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">...</span><span class="nx">params</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span> <span class="c1">// an error message log</span>
  <span class="p">},</span>
  <span class="p">...</span> <span class="nx">models</span><span class="p">,</span> <span class="c1">// the models available to the service</span>
  <span class="p">...</span> <span class="nx">contextEnhancers</span><span class="p">,</span> <span class="c1">// the objects defined via context enhancers</span>
  <span class="na">config</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all available config constants from the service configuration</span>
  <span class="p">},</span>
  <span class="na">helpers</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// all helper functions loaded from the helpers folder</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre>
<p>A task handler gets called when another task asks a service to do a specific task, but it does not matter when (must not run directly, only important for one service)</p>
<h2 id='models'>Models</h2>
<blockquote>
<p>A model represents a persistable, document based storable object.
Under the hood, mongoose is used so you can define a model like you would normally do when defining a mongoose schema.</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="kr">const</span> <span class="nx">modelDefinition</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">firstName</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nb">String</span><span class="p">,</span>
    <span class="na">required</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">},</span>
  <span class="na">cool</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="nb">Boolean</span><span class="p">,</span>
    <span class="na">required</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">default</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">modelDefinition</span><span class="p">;</span>

</code></pre>
<p>Define the models you need as separate files inside the models directory.
They become available in all handlers (invocations, events and tasks) as their camel cased name under the context.</p>

<p>Example:</p>

<p>The model definition file <code>models/user-account.js</code> will become available as <code>context.userAccount</code>;</p>
<h3 id='model-methods'>Model methods</h3>
<blockquote>
<p>A model contains the default CRUD methods plus count and distinct.</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code>
<span class="c1">// some handler, we will use the model defined above</span>

<span class="kr">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>

<span class="c1">// count all matching query</span>
<span class="kr">const</span> <span class="nx">accountCount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">count</span><span class="p">({</span><span class="na">cool</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="c1">// distinct fields matching query</span>
<span class="kr">const</span> <span class="nx">distinctFirstNames</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">distinct</span><span class="p">(</span><span class="s1">'firstName'</span><span class="p">,</span> <span class="p">{</span><span class="na">cool</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>
<span class="c1">// returns an array of strings of all account first names where cool is false.</span>

<span class="c1">// Create one model.</span>
<span class="kr">const</span> <span class="nx">newAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">createOne</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'John'</span><span class="p">});</span>
<span class="cm">/*
const newAccount = {
    id: 'uuid',
    firstName: 'John',
    createdAt: 'ISO Timestamp',
    updatedAt: 'ISO Timestamp'
  };
*/</span>

<span class="c1">// Create one model.</span>
<span class="kr">const</span> <span class="nx">newAccounts</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">createMany</span><span class="p">([{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Peter'</span><span class="p">}]);</span>
<span class="cm">/*
const newAccounts = [
    {
      id: 'uuid',
      firstName: 'Peter',
      createdAt: 'ISO Timestamp',
      updatedAt: 'ISO Timestamp'
    }
  ]
*/</span>

<span class="c1">// find one</span>
<span class="kr">const</span> <span class="nx">someAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Hans'</span><span class="p">});</span>
<span class="c1">// or find by id</span>
<span class="kr">const</span> <span class="nx">anotherAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">findOneById</span><span class="p">(</span><span class="s1">'some-uuid'</span><span class="p">);</span>
<span class="c1">// or find many</span>
<span class="kr">const</span> <span class="nx">moreAccounts</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">findMany</span><span class="p">({</span><span class="na">cool</span><span class="p">:</span> <span class="kc">false</span><span class="p">});</span>

<span class="c1">// update one account</span>
<span class="kr">const</span> <span class="nx">updatedAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Hans'</span><span class="p">},</span> <span class="p">{</span><span class="na">cool</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>
<span class="c1">// or update one account by id</span>
<span class="kr">const</span> <span class="nx">anotherUpdatedAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">updateOneById</span><span class="p">(</span><span class="s1">'some-uuid'</span><span class="p">,</span> <span class="p">{</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Anna'</span><span class="p">});</span>
<span class="c1">// or update many</span>
<span class="kr">const</span> <span class="nx">moreUpdatedAccounts</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">updateMany</span><span class="p">({</span><span class="na">cool</span><span class="p">:</span> <span class="kc">false</span><span class="p">},</span> <span class="p">{</span><span class="na">cool</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="c1">// remove one account</span>
<span class="kr">const</span> <span class="nx">removedAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">removeOne</span><span class="p">({</span><span class="na">firstName</span><span class="p">:</span> <span class="s1">'Hans'</span><span class="p">});</span>
<span class="c1">// or remove one account by id</span>
<span class="kr">const</span> <span class="nx">anotherRemovedAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">removeOneById</span><span class="p">(</span><span class="s1">'some-uuid'</span><span class="p">);</span>
<span class="c1">// or remove many</span>
<span class="kr">const</span> <span class="nx">moreRemovedAccounts</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">userAccount</span><span class="p">.</span><span class="nx">removeMany</span><span class="p">({</span><span class="na">cool</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">;</span>

</code></pre><h1 id='testing'>Testing</h1>
<p>Testing was designed to be super simple and independent of other services. As a test framework jest is supposed to be used.</p>

<blockquote>
<p>Lets imagine we have an invocation handler file <code>create-account.js</code>.</p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// create-account.js</span>

<span class="cm">/**
 * This handler will create a new user account.
 *
 * @param context &lt;&gt; - The default invocation context
 * @param name &lt;String&gt; - The name of the new account
 *
 * @returns the new account
 */</span>
<span class="kr">const</span> <span class="nx">createAccount</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">firstName</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">newAccount</span><span class="p">;</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">newAccount</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nx">createOne</span><span class="p">({</span> <span class="nx">name</span> <span class="p">});</span>
  <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s1">'Failed to create account'</span><span class="p">,</span> <span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Failed to create account'</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'account-created'</span><span class="p">,</span> <span class="nx">newAccount</span><span class="p">);</span>

  <span class="k">return</span> <span class="nx">newAccount</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">createAccount</span><span class="p">;</span>
</code></pre>
<blockquote>
<p>To test it we will create a new file next to it called <code>create-account.test.js</code></p>
</blockquote>
<pre class="highlight javascript tab-javascript"><code><span class="c1">// create-account.test.js</span>
<span class="kr">const</span> <span class="p">{</span> <span class="nx">handler</span><span class="p">,</span> <span class="nx">contextBuilder</span><span class="p">,</span> <span class="nx">db</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">requireHandler</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'./create-account'</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'create-account'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'account creation should return account object with correct properties'</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Arrange</span>
    <span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">contextBuilder</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">firstName</span> <span class="o">=</span> <span class="s1">'Peter'</span><span class="p">;</span>

    <span class="c1">// Act</span>
    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">firstName</span><span class="p">);</span>

    <span class="c1">// Assert</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">account</span><span class="p">).</span><span class="nx">not</span><span class="p">.</span><span class="nx">toBeNull</span><span class="p">();</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">account</span><span class="p">.</span><span class="nx">firstName</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="nx">firstName</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">account</span><span class="p">.</span><span class="nx">cool</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'account creation should emit account-created event'</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Arrange</span>
    <span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">contextBuilder</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">firstName</span> <span class="o">=</span> <span class="s1">'Peter'</span><span class="p">;</span>

    <span class="c1">// Act</span>
    <span class="kr">const</span> <span class="nx">account</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">firstName</span><span class="p">);</span>

    <span class="c1">// Assert</span>
    <span class="c1">// This uses mocks from jest. They are accessible through context.mocks.emit('event'), context.mocks.invoke('service', 'handler') and context.mocks.task.create('service', 'task-handler')</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">'account-created'</span><span class="p">)).</span><span class="nx">toHaveBeenCalledWith</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'Lets imagine that our service calls another service and relies on a value'</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Arrange</span>
    <span class="kr">const</span> <span class="nx">context</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">contextBuilder</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">firstName</span> <span class="o">=</span> <span class="s1">'Peter'</span><span class="p">;</span>

    <span class="c1">// the following line would mock the return value of the in-handler invoke call to the handler "some-handler" of "some-service" to return {id: '123', allGood: true}</span>
    <span class="c1">// check https://jestjs.io/docs/en/mock-function-api.html to get a full list of values</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">'some-service'</span><span class="p">,</span> <span class="s1">'some-handler'</span><span class="p">).</span><span class="nx">mockReturnValue</span><span class="p">({</span><span class="na">id</span><span class="p">:</span> <span class="s1">'123'</span><span class="p">,</span> <span class="na">allGood</span><span class="p">:</span> <span class="kc">true</span><span class="p">});</span>

    <span class="c1">// Act</span>
    <span class="nx">await</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">context</span><span class="p">,</span> <span class="nx">firstName</span><span class="p">);</span>

    <span class="c1">// Assert</span>
    <span class="c1">// This uses mocks from jest. They are accessible through context.mocks.emit('event'), context.mocks.invoke('service', 'handler') and context.mocks.task.create('service', 'task-handler')</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">'some-service'</span><span class="p">,</span> <span class="s1">'some-handler'</span><span class="p">)).</span><span class="nx">toHaveBeenCalledTimes</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="c1">// or simply</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">mocks</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">'some-service'</span><span class="p">,</span> <span class="s1">'some-handler'</span><span class="p">)).</span><span class="nx">toHaveBeenCalled</span><span class="p">();</span>
  <span class="p">});</span>

<span class="p">});</span>

</code></pre>
<p>For this to work we will need to install the flare rest plugin and add a jest plugin definition.</p>

<p><code>yarn add -D jest-plugins jest-plugin-flare</code></p>

<p>You will also need to create a file called <code>jest-plugins.js</code> in the root of your service.</p>
<pre class="highlight javascript tab-javascript"><code><span class="cm">/* eslint-disable import/no-extraneous-dependencies */</span>
<span class="c1">// jest-plugins.js</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'jest-plugins'</span><span class="p">)([</span>
  <span class="s1">'jest-plugin-flare'</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre>
<blockquote>
<p>As well as modifing the <code>package.json</code> to include the following block</p>
</blockquote>
<pre class="highlight plaintext"><code>{
  # ... rest of package.json
  "jest": {
    "setupTestFrameworkScriptFile": "./jest-plugins.js"
  }
}
</code></pre><h1 id='restrictions'>Restrictions</h1>
<p>Some restrictions apply.</p>
<h3 id='the-service-name'>The service name</h3>
<p>A service name may not start with the prefix <code>sys-</code> as it is reserved for system services with possibly escalated privileges.</p>
<h3 id='context-enhancers-2'>Context enhancers</h3>
<p>Context enhancers may not have the following names: <code>cid</code>, <code>helpers</code>, <code>config</code>, <code>invocation</code>, <code>task</code>, <code>event</code>, <code>invoke</code>, <code>emit</code>, <code>self</code>, <code>log</code>, <code>cache</code> or any registered model name or context enhancer name.</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="javascript">javascript</a>
          </div>
      </div>
    </div>
  </body>
</html>
